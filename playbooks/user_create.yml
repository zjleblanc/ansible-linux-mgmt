---
- name: Create users
  hosts: camp
  gather_facts: false
  become: true

  vars_files:
    - vars/camper_creds.yml
    - vars/campers.yml

  tasks:
    - name: Ensure camp is open
      block:
        - name: Check if camp is open
          ansible.builtin.wait_for_connection:
          timeout: 30
      rescue:
        - name: Gracefully bail out if camp is closed
          ansible.builtin.meta: end_play

    - name: Create campers group
      ansible.builtin.group:
        name: campers

    - name: Create users
      loop: "{{ campers }}"
      loop_control:
        loop_var: camper
        label: "{{ camper.username }}"
      ansible.builtin.include_tasks:
        file: tasks/user_create.yml
